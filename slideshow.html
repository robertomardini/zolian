<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Slideshow – Zolian TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    #slides { position:relative; width:100vw; height:100vh; }
    #slides img {
      position:absolute; width:100%; height:100%;
      object-fit:contain; opacity:0;
      transition:opacity 1s ease-in-out;
    }
  </style>
</head>
<body>
  <div id="slides"></div>
  <script>
    (async()=>{
      const code = new URLSearchParams(location.search).get('code');
      if (!code) return alert('Falta ?code en la URL');

      // Función que arranca/rearranca el slideshow
      async function arrancar(galleryId, duration) {
        // fullscreen
        document.documentElement.requestFullscreen?.();
        // cargar urls
        const { data: imgs } = await supabase
          .from('images')
          .select('url')
          .eq('gallery_id', galleryId)
          .order('created_at',{ascending:true});
        if (!imgs.length) return console.warn('Sin imágenes');
        const cont = document.getElementById('slides');
        cont.innerHTML = '';
        const urls = imgs.map(i =>
          supabase.storage.from('images').getPublicUrl(i.url).data.publicUrl
        );
        urls.forEach((src,i)=>{
          const img = document.createElement('img');
          img.src = src;
          img.style.opacity = i===0 ? 1 : 0;
          cont.appendChild(img);
        });
        let idx=0;
        setInterval(()=>{
          const all = cont.querySelectorAll('img');
          all[idx].style.opacity = 0;
          idx = (idx+1)%all.length;
          all[idx].style.opacity = 1;
        }, duration*1000);
      }

      // 1) Cargar estado inicial
      const { data: tv } = await supabase
        .from('tv')
        .select('gallery_id,duration')
        .eq('code', code)
        .maybeSingle();
      if (tv && tv.gallery_id) {
        arrancar(tv.gallery_id, tv.duration);
      }

      // 2) Suscribirse a cambios
      supabase
        .from(`tv:code=eq.${code}`)
        .on('UPDATE', payload => {
          const nt = payload.new;
          if (nt.gallery_id) {
            arrancar(nt.gallery_id, nt.duration);
          }
        })
        .subscribe();
    })();
  </script>
</body>
</html>
