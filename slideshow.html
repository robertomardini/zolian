<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Slideshow</title>
  <link rel="stylesheet" href="style.css">
  <script src="supabaseClient.js"></script>
</head>
<body style="margin:0; background:#000;">
  <div id="slideshow" style="width:100vw; height:100vh; display:flex; align-items:center; justify-content:center;"></div>

  <script>
    const supabase = window.supabase;
    const params   = new URLSearchParams(window.location.search);
    const screenId = params.get('code');

    let currentAlbum = null;
    let images       = [];
    let idx          = 0;
    let timer;

    // Carga las URLs de un álbum y arranca el ciclo
    async function loadAlbum(albumId) {
      currentAlbum = albumId;
      clearTimeout(timer);

      const { data, error } = await supabase
        .from('images')
        .select('url')
        .eq('album_id', albumId)
        .order('order');
      if (error) return console.error('Error fetch imágenes:', error);

      images = data.map(i => i.url);
      idx    = 0;
      showNext();
    }

    // Muestra la siguiente imagen y reprograma el timeout
    function showNext() {
      if (!images.length) return;
      document.getElementById('slideshow').innerHTML =
        `<img src="${images[idx]}" style="max-width:100%; max-height:100%;">`;
      idx = (idx + 1) % images.length;
      timer = setTimeout(showNext, 5000); // cada 5s
    }

    (async () => {
      // 1) Suscríbete a cambios en este screen
      supabase
        .from(`screens:id=eq.${screenId}`)
        .on('UPDATE', payload => {
          const a = payload.new.current_album_id;
          if (a && a !== currentAlbum) loadAlbum(a);
        })
        .subscribe();

      // 2) Chequeo inicial: quizá ya hay un álbum asignado
      const { data: scr, error } = await supabase
        .from('screens')
        .select('current_album_id')
        .eq('id', screenId)
        .single();
      if (error) return console.error('Error fetch screen:', error);
      if (scr.current_album_id) loadAlbum(scr.current_album_id);
    })();
  </script>
</body>
</html>
