<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Slideshow – Zolian TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>

  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    #slides { position:relative; width:100vw; height:100vh; }
    #slides img {
      position:absolute;
      width:100%;
      height:100%;
      object-fit:contain;
      opacity:0;
      transition: opacity 1s ease-in-out;
    }
  </style>
</head>
<body>
  <div id="slides"></div>

  <script>
    (async () => {
      const code = new URLSearchParams(location.search).get('code');
      if (!code) {
        alert('Falta ?code en la URL');
        return;
      }

      const slidesEl   = document.getElementById('slides');
      let intervalId   = null;

      // Función que limpia y arranca un slideshow
      async function arrancar(galleryId, duration) {
        // 1) Clear anterior
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
        slidesEl.innerHTML = '';

        // 2) Traer imágenes del álbum
        const { data: imgs, error: imgErr } = await supabase
          .from('images')
          .select('url')
          .eq('gallery_id', galleryId)
          .order('created_at', { ascending: true });
        if (imgErr) {
          console.error('Error cargando imágenes:', imgErr);
          return;
        }
        if (!imgs.length) {
          console.warn('Sin imágenes en el álbum');
          return;
        }

        // 3) Obtener URLs públicas
        const urls = imgs.map(i =>
          supabase
            .storage
            .from('images')
            .getPublicUrl(i.url)
            .data
            .publicUrl
        );

        // 4) Pintar slides (primero visible, resto ocultos)
        urls.forEach((src, i) => {
          const img = document.createElement('img');
          img.src = src;
          img.style.opacity = i === 0 ? '1' : '0';
          slidesEl.appendChild(img);
        });

        // 5) Arrancar el ciclo con la duración indicada
        let idx = 0;
        intervalId = setInterval(() => {
          const lis = slidesEl.querySelectorAll('img');
          lis[idx].style.opacity = '0';
          idx = (idx + 1) % lis.length;
          lis[idx].style.opacity = '1';
        }, duration * 1000);
      }

      // 1) Request Fullscreen al entrar (si no se hizo ya por user action)
      document.documentElement.requestFullscreen?.().catch(() => {
        /* Algunas TVs o navegadores bloquean fullscreen sin user gesture */
      });

      // 2) Carga inicial de gallery_id & duration desde la fila `tv`
      const { data: tv, error: tvErr } = await supabase
        .from('tv')
        .select('gallery_id,duration')
        .eq('code', code)
        .maybeSingle();
      if (tvErr) {
        console.error('Error leyendo TV:', tvErr);
      } else if (tv?.gallery_id) {
        await arrancar(tv.gallery_id, tv.duration);
      }

      // 3) Suscripción Realtime a cambios en esa fila `tv`
      supabase
        .channel(`tv_updates_${code}`)
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'tv',
          filter: `code=eq.${code}`
        }, ({ new: updated }) => {
          if (updated.gallery_id) {
            arrancar(updated.gallery_id, updated.duration);
          }
        })
        .subscribe();
    })();
  </script>
</body>
</html>
