<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Mis V√≠deos ‚Äì Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <style>
    /* ... (mismos estilos) ... */
  </style>
</head>
<body>
  <div id="sidebar-container"></div>
  <section class="home">
    <p>Usuario: <strong id="user-email"></strong></p>
    <h2>Mis V√≠deos</h2>
    <div class="section">
      <label for="video-file">Selecciona v√≠deo</label>
      <input type="file" id="video-file" accept="video/*"/>
      <button id="upload-video">Subir V√≠deo</button>
      <span id="video-status"></span>
    </div>
    <div class="section">
      <span id="list-status"></span>
    </div>
    <ul id="videos-list"></ul>
  </section>

  <script>
    async function initMisVideos() {
      const { data:{ session }, error: sessErr } = await supabase.auth.getSession();
      if (sessErr || !session) {
        const redirect = encodeURIComponent(location.pathname + location.search);
        return window.location.href = `login.html?redirect=${redirect}`;
      }
      document.getElementById('user-email').innerText = session.user.email;

      async function loadVideos() {
        const status = document.getElementById('list-status');
        const ul     = document.getElementById('videos-list');
        status.innerText = 'Cargando v√≠deos‚Ä¶';
        ul.innerHTML     = '';
        const { data: vids, error } = await supabase
          .from('videos')
          .select('id, url, title')
          .eq('user_id', session.user.id)
          .order('created_at', { ascending: false });
        if (error) {
          status.innerText = 'Error cargando v√≠deos.';
          return;
        }
        if (!vids.length) {
          status.innerText = 'No tienes v√≠deos a√∫n.';
          return;
        }
        status.innerText = '';
        for (let v of vids) {
          const { data:{ publicUrl } } = supabase
            .storage.from('videos')
            .getPublicUrl(v.url);
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${v.title || v.url.split('/').pop()}</span>
            <div>
              <button class="play">‚ñ∂</button>
              <button class="del">üóë</button>
            </div>
          `;
          li.querySelector('.play').onclick = () => {
            window.open(publicUrl, '_blank');
          };
          li.querySelector('.del').onclick = async () => {
            if (!confirm('¬øBorrar este v√≠deo?')) return;
            // 1) Borrar archivo en Storage
            const { error: rmErr } = await supabase
              .storage
              .from('videos')
              .remove([ v.url ]);
            if (rmErr) {
              alert('Error borrando el archivo: ' + rmErr.message);
              return;
            }
            // 2) Borrar metadato
            await supabase
              .from('videos')
              .delete()
              .eq('id', v.id);
            await loadVideos();
          };
          ul.appendChild(li);
        }
      }

      document.getElementById('upload-video').addEventListener('click', async () => {
        const inp    = document.getElementById('video-file');
        const status = document.getElementById('video-status');
        if (!inp.files.length) {
          alert('Selecciona un archivo.');
          return;
        }
        const file = inp.files[0];
        const path = `videos/${session.user.id}/${Date.now()}_${file.name}`;
        inp.disabled     = true;
        status.innerText = 'Subiendo v√≠deo‚Ä¶';
        const { error: upErr } = await supabase
          .storage
          .from('videos')
          .upload(path, file, { upsert: false });
        if (upErr) {
          alert('Error subiendo v√≠deo: ' + upErr.message);
        } else {
          await supabase
            .from('videos')
            .insert({ user_id: session.user.id, url: path, title: file.name });
          await loadVideos();
        }
        inp.disabled     = false;
        status.innerText = '';
      });

      await loadVideos();
    }

    document.addEventListener('DOMContentLoaded', initMisVideos);
    window.addEventListener('sidebarReady', initMisVideos);
  </script>
</body>
</html>
