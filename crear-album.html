<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Crear Álbum – Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    body { font-family:Arial,sans-serif; padding:20px; }
    h1 { margin-bottom:12px; }
    input, button { width:100%; padding:8px; margin-top:8px; }
    button { cursor:pointer; }
    #msg { color:red; margin-top:8px; }
  </style>
</head>
<body>
  <h1>Crear Álbum</h1>
  <input id="album-name" type="text" placeholder="Nombre del álbum"/>
  <button id="create-btn">Crear Álbum</button>
  <p id="msg"></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <script>
  (async () => {
    // Si venimos de vincular, recibimos ?code=…
    const tvCode = new URLSearchParams(location.search).get('code');
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session) {
      const r = encodeURIComponent(location.pathname + location.search);
      return window.location.href = `login.html?redirect=${r}`;
    }

    document.getElementById('create-btn').onclick = async () => {
      const name = document.getElementById('album-name').value.trim();
      const msg  = document.getElementById('msg');
      msg.innerText = '';
      if (!name) return msg.innerText = 'Debes escribir un nombre.';

      const { data: gallery, error } = await supabase
        .from('galleries')
        .insert({ name, user_id: session.user.id })
        .select()
        .single();
      if (error) {
        msg.innerText = 'Error al crear álbum.';
        console.error(error);
        return;
      }

      if (tvCode) {
        const { error: err2 } = await supabase
          .from('tv')
          .update({ gallery_id: gallery.id, play: true })
          .eq('code', tvCode);
        if (err2) {
          alert('Álbum creado, pero no se vinculó: ' + err2.message);
          return window.location.href = `/album.html?gallery=${gallery.id}`;
        }
        return window.location.href = `/slideshow.html?code=${tvCode}`;
      }

      window.location.href = `/album.html?gallery=${gallery.id}`;
    };
  })();
  </script>
</body>
</html>
