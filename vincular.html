<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Vincular Pantalla - Zolian App</title>

  <!-- Estilos y Boxicons -->
  <link rel="stylesheet" href="/style.css" />
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>

  <style>
    .home { padding: 20px; transition: left 0.3s, width 0.3s; }
    .home .text { margin-bottom: 16px; }
    #nome-btn, #ok-btn { margin-top: 12px; }
  </style>
</head>
<body>
  <!-- Sidebar inyectado -->
  <div id="sidebar-container"></div>

  <!-- Contenido principal -->
  <section class="home">
    <div class="text">Vincular Pantalla</div>
    <p>Código: <strong id="codeDisplay"></strong></p>
    <label for="nombre">Nombre de la pantalla</label>
    <input type="text" id="nombre" placeholder="Ej. Sala de espera" />
    <button id="ok-btn">OK</button>
    <p id="msg" style="color:red;"></p>
  </section>

  <!-- Supabase y scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <script src="/script.js"></script>
  <script>
    async function initVincular() {
      const params = new URLSearchParams(window.location.search);
      let code = params.get('code');
      if (!code) {
        // genera uno si falta
        code = crypto.randomUUID();
        window.history.replaceState(null, '', `?code=${code}`);
      }
      document.getElementById('codeDisplay').innerText = code;

      // Sesión
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const redirect = encodeURIComponent(`/vincular.html?code=${code}`);
        return window.location.href = `login.html?redirect=${redirect}`;
      }
      const user = session.user;

      // Inyectar email
      const su = document.getElementById('sidebar-user');
      if (su) su.innerText = user.email;

      // Logout
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.onclick = async e => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = 'login.html';
        };
      }

      // Consultar si ya existe
      const { data: record, error } = await supabase
        .from('tv')
        .select('user_id, nombre')
        .eq('code', code)
        .maybeSingle();
      if (error) {
        document.getElementById('msg').innerText = 'Error al consultar.';
        return;
      }
      if (record && record.user_id && record.user_id !== user.id) {
        document.getElementById('msg').innerText = 'Esta pantalla está vinculada.';
        return;
      }
      if (record) {
        document.getElementById('nombre').value = record.nombre || '';
      }

      // OK → insert/update + redirigir
      document.getElementById('ok-btn').onclick = async () => {
        const nombre = document.getElementById('nombre').value.trim();
        if (!nombre) {
          document.getElementById('msg').innerText = 'Ingresa un nombre.';
          return;
        }
        const fn = record
          ? supabase.from('tv').update({ user_id: user.id, nombre }).eq('code', code)
          : supabase.from('tv').insert({ code, user_id: user.id, nombre });
        const { error: upErr } = await fn;
        if (upErr) {
          document.getElementById('msg').innerText = 'Error al guardar.';
          return;
        }
        window.location.href = `administrar.html?code=${code}`;
      };
    }

    window.addEventListener('sidebarReady', initVincular);
  </script>
</body>
</html>
