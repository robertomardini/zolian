<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Administrar Pantalla – Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Tu CSS principal -->
  <link rel="stylesheet" href="/style.css"/>
  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>

  <!-- Supabase y sidebar injector -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <script src="/script.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container"></div>
  <div class="overlay"></div>

  <section class="home">
    <h1>Editar Pantalla</h1>

    <!-- Tarjeta de la pantalla -->
    <div id="screenCard" class="screen-card">
      <box-icon name="tv" size="48px"></box-icon>
      <span id="screenName">Pantalla</span>
    </div>

    <!-- Bloque de álbumes -->
    <div class="admin-block">
      <h2>Selecciona un álbum</h2>
      <ul id="galleryList" class="item-list"></ul>
      <button id="createAlbum">
        <box-icon name="plus"></box-icon>
        Crear nuevo álbum
      </button>
    </div>

    <!-- Bloque de vídeos -->
    <div class="admin-block">
      <h2>Selecciona un vídeo</h2>
      <ul id="videoList" class="item-list"></ul>
      <button id="createVideo">
        <box-icon name="video-plus"></box-icon>
        Subir nuevo vídeo
      </button>
    </div>

    <!-- Desvincular pantalla -->
    <p id="unlink"> Desvincular esta pantalla</p>
  </section>

  <script>
  (async () => {
    const code = new URLSearchParams(location.search).get('code');
    if (!code) {
      window.location.href = 'pantallas.html';
      return;
    }

    // 1) Sesión
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      const r = encodeURIComponent(location.pathname + location.search);
      window.location.href = `login.html?redirect=${r}`;
      return;
    }

    // 2) Datos de la TV
    const { data: tv, error: tvErr } = await supabase
      .from('tv')
      .select('nombre,user_id')
      .eq('code', code)
      .maybeSingle();
    if (tvErr || !tv || tv.user_id !== session.user.id) {
      window.location.href = 'pantallas.html';
      return;
    }
    document.getElementById('screenName').innerText = tv.nombre;

    // Etiquetas legibles para los tipos de slideshow
    const typeLabels = {
      fade:     'Fade',
      slide:    'Slide Horizontal',
      vertical: 'Slide Vertical',
      zoom:     'Zoom',
      kenburns: 'Ken Burns'
    };

    // 3) Listar álbumes con thumbnail o icono fallback
    const { data: galleries, error: galErr } = await supabase
      .from('galleries')
      .select('id,name,duration,slideshow_type')
      .eq('user_id', session.user.id)
      .order('created_at', { ascending: false });
    if (galErr) {
      console.error('Error cargando galerías:', galErr);
    }
    const gl = document.getElementById('galleryList');
    gl.innerHTML = '';
    for (let g of galleries || []) {
      // obtener la imagen más reciente (si existe)
      const { data: imgData } = await supabase
        .from('images')
        .select('url')
        .eq('gallery_id', g.id)
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      let thumbHtml = `<box-icon name="image-alt" size="32px"></box-icon>`;
      if (imgData && imgData.url) {
        const { data: { publicUrl } } = supabase
          .storage.from('images')
          .getPublicUrl(imgData.url);
        thumbHtml = `<img class="thumb" src="${publicUrl}" alt="Miniatura"/>`;
      }

      const li = document.createElement('li');
      const meta = `${typeLabels[g.slideshow_type] || g.slideshow_type} • ${g.duration}s`;
      li.innerHTML = `
        <div class="thumb-container">${thumbHtml}</div>
        <div class="info-block">
          <span class="album-name">${g.name}</span>
          <span class="meta">${meta}</span>
        </div>
      `;
      li.onclick = async () => {
        const { error } = await supabase
          .from('tv')
          .update({
            gallery_id:     g.id,
            duration:       g.duration,
            slideshow_type: g.slideshow_type,
            play:           true,
            video_url:      null
          })
          .eq('code', code);
        if (error) {
          alert('Error asignando álbum: ' + error.message);
        } else {
          alert('Álbum asignado.');
        }
      };
      gl.appendChild(li);
    }

    // 4) Listar vídeos
    const { data: vids, error: vidErr } = await supabase
      .from('videos')
      .select('id,url,title')
      .eq('user_id', session.user.id)
      .order('created_at', { ascending: false });
    if (vidErr) {
      console.error('Error cargando vídeos:', vidErr);
    }
    const vl = document.getElementById('videoList');
    vl.innerHTML = '';
    for (let v of vids || []) {
      const title = v.title || v.url.split('/').pop();
      const li = document.createElement('li');
      li.innerHTML = `<span>${title}</span><span class="meta">Vídeo</span>`;
      li.onclick = async () => {
        const { error } = await supabase
          .from('tv')
          .update({
            video_url:  v.url,
            play:       true,
            gallery_id: null
          })
          .eq('code', code);
        if (error) {
          alert('Error asignando vídeo: ' + error.message);
        } else {
          alert('Vídeo asignado.');
        }
      };
      vl.appendChild(li);
    }

    // 5) Botones crear
    document.getElementById('createAlbum').onclick = () =>
      location.href = `crear-album.html?code=${code}`;
    document.getElementById('createVideo').onclick = () =>
      location.href = `misvideos.html`;

    // 6) Desvincular pantalla
    document.getElementById('unlink').onclick = async () => {
      if (!confirm('¿Desvincular pantalla?')) return;
      const { error } = await supabase
        .from('tv')
        .update({ user_id:null, gallery_id:null, video_url:null, play:false })
        .eq('code', code);
      if (error) {
        alert('Error al desvincular: ' + error.message);
      } else {
        alert('Pantalla desvinculada.');
        window.location.href = 'pantallas.html';
      }
    };
  })();
  </script>
</body>
</html>
