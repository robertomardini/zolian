<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Administrar Pantalla â€“ Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Tu CSS principal -->
  <link rel="stylesheet" href="/style.css"/>
  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>

  <!-- Supabase y sidebar injector -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <script src="/script.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container"></div>
  <div class="overlay"></div>

  <section class="home">
    <h1>Editar Pantalla</h1>

    <!-- Tarjeta de la pantalla -->
    <div id="screenCard" class="screen-card">
      <box-icon name="tv" size="48px"></box-icon>
      <span id="screenName">Pantalla</span>
    </div>

    <!-- Bloque de Ã¡lbumes -->
    <div class="admin-block">
      <h2>Selecciona un Ã¡lbum</h2>
      <ul id="galleryList" class="item-list"></ul>
      <button id="createAlbum">
        <box-icon name="plus"></box-icon>
        Crear nuevo Ã¡lbum
      </button>
    </div>

    <!-- Bloque de vÃ­deos -->
    <div class="admin-block">
      <h2>Selecciona un vÃ­deo</h2>
      <ul id="videoList" class="item-list"></ul>
      <button id="createVideo">
        <box-icon name="video-plus"></box-icon>
        Subir nuevo vÃ­deo
      </button>
    </div>

    <!-- Desvincular pantalla -->
    <p id="unlink">ðŸ”— Desvincular esta pantalla</p>
  </section>

  <script>
  (async () => {
    const code = new URLSearchParams(location.search).get('code');
    if (!code) {
      window.location.href = 'pantallas.html';
      return;
    }

    // 1) SesiÃ³n
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session) {
      const r = encodeURIComponent(location.pathname + location.search);
      window.location.href = `login.html?redirect=${r}`;
      return;
    }

    // 2) Datos de la TV
    const { data: tv } = await supabase
      .from('tv')
      .select('nombre,user_id')
      .eq('code', code)
      .maybeSingle();
    if (!tv || tv.user_id !== session.user.id) {
      window.location.href = 'pantallas.html';
      return;
    }
    document.getElementById('screenName').innerText = tv.nombre;

    // 3) Listar Ã¡lbumes con thumbnail o icono fallback
    const { data: galleries } = await supabase
      .from('galleries')
      .select('id,name,duration,slideshow_type')
      .eq('user_id', session.user.id)
      .order('created_at',{ ascending:false });

    const gl = document.getElementById('galleryList');
    gl.innerHTML = '';

    const typeLabels = {
      fade:     'Fade',
      slide:    'Slide Horizontal',
      vertical: 'Slide Vertical',
      zoom:     'Zoom',
      kenburns: 'Ken Burns'
    };

    for (let g of galleries) {
      // obtener la imagen mÃ¡s reciente (puede no existir)
      const { data: img } = await supabase
        .from('images')
        .select('url')
        .eq('gallery_id', g.id)
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      let thumbHtml;
      if (img && img.url) {
        const publicUrl = supabase
          .storage
          .from('images')
          .getPublicUrl(img.url)
          .data.publicUrl;
        thumbHtml = `<img class="thumb" src="${publicUrl}" alt="Miniatura"/>`;
      } else {
        thumbHtml = `<box-icon name="image-alt" size="32px"></box-icon>`;
      }

      // montar li
      const li = document.createElement('li');
      const meta = `${typeLabels[g.slideshow_type]||g.slideshow_type} â€¢ ${g.duration}s`;
      li.innerHTML = `
        <div class="thumb-container">${thumbHtml}</div>
        <div class="info-block">
          <span class="album-name">${g.name}</span>
          <span class="meta">${meta}</span>
        </div>
      `;
      li.onclick = async () => {
        await supabase
          .from('tv')
          .update({
            gallery_id:     g.id,
            duration:       g.duration,
            slideshow_type: g.slideshow_type,
            play:           true,
            video_url:      null
          })
          .eq('code', code);
        alert('Ãlbum asignado.');
      };
      gl.appendChild(li);
    }

    // 4) Listar vÃ­deos (igual que antes)â€¦
    const { data: vids } = await supabase
      .from('videos')
      .select('id,url,title')
      .eq('user_id', session.user.id)
      .order('created_at',{ ascending:false });

    const vl = document.getElementById('videoList');
    vl.innerHTML = '';
    vids.forEach(v => {
      const title = v.title || v.url.split('/').pop();
      const li = document.createElement('li');
      li.innerHTML = `<span>${title}</span><span class="meta">VÃ­deo</span>`;
      li.onclick = async () => {
        await supabase
          .from('tv')
          .update({
            video_url:  v.url,
            play:       true,
            gallery_id: null
          })
          .eq('code', code);
        alert('VÃ­deo asignado.');
      };
      vl.appendChild(li);
    });

    // 5) Botones crear
    document.getElementById('createAlbum').onclick = () =>
      location.href = `crear-album.html?code=${code}`;
    document.getElementById('createVideo').onclick = () =>
      location.href = `misvideos.html`;

    // 6) Desvincular pantalla
    document.getElementById('unlink').onclick = async () => {
      if (!confirm('Â¿Desvincular pantalla?')) return;
      await supabase
        .from('tv')
        .update({ user_id:null, gallery_id:null, video_url:null, play:false })
        .eq('code', code);
      alert('Pantalla desvinculada.');
      window.location.href = 'pantallas.html';
    };
  })();
  </script>
</body>
</html>
