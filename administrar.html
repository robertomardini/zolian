<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Administrar Pantalla â€“ Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <style>
    /* ... (misma hoja de estilos) ... */
  </style>
</head>
<body>
  <h1>Administrar Pantalla</h1>
  <p>Pantalla: <strong id="screenName"></strong></p>
  <p>Usuario: <strong id="userEmail"></strong></p>
  <!-- ... listados de Ã¡lbumes y vÃ­deos, botones ... -->
  <p id="unlink" style="color:red; margin-top:24px; cursor:pointer;">ðŸ”— Eliminar pantalla</p>

  <script>
  (async () => {
    const code = new URLSearchParams(location.search).get('code');
    if (!code) {
      alert('Falta cÃ³digo de TV');
      return location.href = 'pantallas.html';
    }
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session) {
      const r = encodeURIComponent(location.pathname+location.search);
      return location.href = `login.html?redirect=${r}`;
    }
    document.getElementById('userEmail').innerText = session.user.email;
    const { data: tv, error: tvErr } = await supabase
      .from('tv').select('nombre,user_id').eq('code',code).maybeSingle();
    if (tvErr || !tv || tv.user_id !== session.user.id) {
      alert('Pantalla no vÃ¡lida');
      return location.href='pantallas.html';
    }
    document.getElementById('screenName').innerText = tv.nombre;

    // ... listado y asignaciÃ³n de Ã¡lbumes y vÃ­deos ...

    document.getElementById('unlink').onclick = async () => {
      if (!confirm('Â¿Eliminar completamente esta pantalla?')) return;
      // 1) Si habÃ­a un vÃ­deo vinculado, lo borramos de Storage
      const { data: tvData } = await supabase
        .from('tv')
        .select('video_url')
        .eq('code', code)
        .single();
      if (tvData.video_url) {
        const { error: rmErr } = await supabase
          .storage
          .from('videos')
          .remove([ tvData.video_url ]);
        if (rmErr) {
          alert('Error borrando vÃ­deo en Storage: ' + rmErr.message);
          return;
        }
      }
      // 2) Eliminar la fila de tv
      const { error: delErr } = await supabase
        .from('tv')
        .delete()
        .eq('code', code);
      if (delErr) {
        alert('Error eliminando la pantalla: ' + delErr.message);
        return;
      }
      alert('Pantalla eliminada con Ã©xito.');
      location.href = 'pantallas.html';
    };
  })();
  </script>
</body>
</html>
