<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Mi Cuenta – Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- CSS principal -->
  <link rel="stylesheet" href="/style.css"/>

  <!-- Boxicons: estilos y script para los custom elements -->
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/boxicons@2.1.1/dist/boxicons.js"></script>

  <!-- Supabase JS desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <!-- Tu cliente de Supabase -->
  <script src="/supabaseClient.js"></script>
  <!-- Script común que inyecta header/footer y despacha headerReady/footerReady -->
  <script src="/script.js"></script>
</head>
<body>
  <!-- Header inyectado -->
  <div id="header-container"></div>

  <section class="home">
    <h1>Mi Cuenta</h1>

    <div class="block">
      <!-- Email -->
      <div class="field-group">
        <label>Email</label>
        <div id="user-email" class="info-text">cargando…</div>
      </div>

      <!-- Suscripción -->
      <div class="field-group">
        <label>Suscripción</label>
        <div id="user-subscription" class="info-text">cargando…</div>
      </div>

      <!-- Cerrar sesión -->
      <button id="logout-btn" class="primary">
        <box-icon name="log-out"></box-icon>
        Cerrar sesión
      </button>
    </div>
  </section>

  <!-- Footer inyectado -->
  <div id="footer-container"></div>

  <script>
    // Cuando el header ya esté en el DOM y listo:
    window.addEventListener('headerReady', async () => {
      try {
        // 1) Obtener sesión
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          // Si no hay sesión, redirige a login
          const redirect = encodeURIComponent(location.pathname);
          return window.location.href = `login.html?redirect=${redirect}`;
        }

        // 2) Mostrar email
        document.getElementById('user-email').innerText = session.user.email;

        // 3) Leer perfil (supongo que tienes tabla "profiles")
        const { data: profile } = await supabase
          .from('profiles')
          .select('subscription_status')
          .eq('id', session.user.id)
          .maybeSingle();

        const subEl = document.getElementById('user-subscription');
        if (profile && profile.subscription_status) {
          const estados = {
            free:     'Gratuita',
            trial:    'Prueba',
            active:   'Activa',
            canceled: 'Cancelada'
          };
          subEl.innerText = estados[profile.subscription_status] 
            || profile.subscription_status;
        } else {
          subEl.innerText = 'No registrada';
        }

        // 4) Logout desde el botón
        document.getElementById('logout-btn').addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = 'login.html';
        });

      } catch (err) {
        console.error('Error cargando datos de usuario:', err);
      }
    });
  </script>
</body>
</html>
