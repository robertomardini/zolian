<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pantalla</title>
  <link rel="stylesheet" href="style.css">
  <script src="qrcode.min.js"></script>
  <script src="supabaseClient.js"></script>
</head>
<body>
  <div style="text-align:center; padding-top:2rem;">
    <div id="qrcode"></div>
    <p>Escanea con tu móvil para vincular esta pantalla</p>
  </div>

  <script>
    const supabase = window.supabase;
    (async function init() {
      // 1) Inserta un nuevo registro en 'screens'
      const { data: screen, error } = await supabase
        .from('screens')
        .insert({})           // podrá añadirse más info luego
        .select()
        .single();
      if (error) return console.error('Error creando pantalla:', error);

      // 2) Genera el QR apuntando a vincular.html?code=<screen.id>
      const link = `${window.location.origin}/vincular.html?code=${screen.id}`;
      new QRCode(document.getElementById('qrcode'), {
        text: link,
        width: 200,
        height: 200
      });

      // 3) Suscríbete a cambios en este screen
      supabase
        .from(`screens:id=eq.${screen.id}`)
        .on('UPDATE', payload => {
          const nuevo = payload.new.current_album_id;
          if (nuevo) {
            // en cuanto haya un álbum elegido, redirige al slideshow
            window.location.href = `/slideshow.html?code=${screen.id}`;
          }
        })
        .subscribe();
    })();
  </script>
</body>
</html>
