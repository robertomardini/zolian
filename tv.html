<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Slideshow TV</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #000; color: #fff; margin:0; display:flex;
           justify-content:center; align-items:center; height:100vh; }
    img { max-width:100%; max-height:100%; }
  </style>
</head>
<body>
  <div id="status">Cargando imágenes…</div>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/supabaseClient.js"></script>

  <script>
  (async function() {
    // 1) Leer código de TV de la URL
    const params = new URLSearchParams(window.location.search);
    const tvCode = params.get('code');
    if (!tvCode) {
      document.getElementById('status').innerText = 'Falta el parámetro code en la URL';
      return;
    }

    // 2) Recuperar sesión para tener user.id
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      document.getElementById('status').innerText = 'No estás autenticado.';
      return;
    }
    const userId = session.user.id;

    // 3) Construir prefijo en el bucket
    const prefix = `${userId}/${tvCode}`;

    // 4) Listar los objetos
    const { data: files, error } = await supabase
      .storage
      .from('tv-content')
      .list(prefix);
    if (error) {
      console.error(error);
      document.getElementById('status').innerText = 'Error al listar imágenes.';
      return;
    }
    if (files.length === 0) {
      document.getElementById('status').innerText = 'No hay imágenes.';
      return;
    }

    // 5) Crear array de URLs públicas
    const urls = files.map(f =>
      supabase
        .storage
        .from('tv-content')
        .getPublicUrl(`${prefix}/${f.name}`)
        .data
        .publicUrl
    );

    // 6) Mostrar slideshow
    document.getElementById('status').remove();
    const img = document.createElement('img');
    document.body.appendChild(img);

    let idx = 0;
    img.src = urls[0];
    setInterval(() => {
      idx = (idx + 1) % urls.length;
      img.src = urls[idx];
    }, 3000);
  })();
  </script>
</body>
</html>
