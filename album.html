<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Álbum - Zolian App</title>

  <!-- Estilos y Boxicons -->
  <link rel="stylesheet" href="style.css"/>
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>

  <style>
    .home { padding: 20px; }
    .home .text { margin-bottom: 16px; }

    .section { margin-bottom: 24px; }
    .section label { display: block; margin-bottom: 8px; color: var(--text-color); }
    .section input[type="text"],
    .section input[type="file"],
    .section button {
      display: block;
      width: 100%;
      box-sizing: border-box;
    }
    .section input[type="text"] {
      padding: 8px; border:1px solid #ccc; border-radius:4px;
      margin-bottom: 8px;
      background: var(--body-color); color: var(--text-color);
    }
    .section input[type="file"] {
      margin-bottom: 8px;
    }
    .section button {
      padding: 10px; margin-bottom: 8px;
      background: var(--primary-color); color: #fff;
      border: none; border-radius:4px; cursor:pointer;
    }

    #images-list {
      list-style: none;
      padding: 0;
    }
    #images-list li {
      position: relative;
      margin-bottom: 12px;
    }
    #images-list img {
      max-width: 100%;
      border-radius: 4px;
      display: block;
    }
    #images-list .delete-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: rgba(0,0,0,0.5);
      color: #fff; border:none; border-radius:50%;
      width:24px; height:24px; cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar close">
    <header>
      <div class="image-text">
        <span class="image"><img src="logo.png" alt="Logo"/></span>
        <div class="text logo-text">
          <span class="name">Zolian App</span>
          <span class="profession">Easy to share</span>
        </div>
      </div>
      <i class="bx bx-chevron-right toggle"></i>
    </header>
    <div class="menu-bar">
      <div class="menu"></div>
      <div class="bottom-content">
        <li class="nav-link nav-user">
          <a href="#">
            <i class="bx bx-user icon"></i>
            <span class="text nav-text" id="sidebar-user"></span>
          </a>
        </li>
        <li>
          <a href="#" id="logout">
            <i class="bx bx-log-out icon"></i>
            <span class="text nav-text">Cerrar sesión</span>
          </a>
        </li>
        <li class="mode">
          <div class="sun-moon">
            <i class="bx bx-moon icon moon"></i>
            <i class="bx bx-sun icon sun"></i>
          </div>
          <span class="mode-text text">Dark mode</span>
          <div class="toggle-switch"><span class="switch"></span></div>
        </li>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <section class="home">
    <div class="text">Administrar Álbum</div>

    <!-- Mostrar ID del álbum por si acaso -->
    <div class="section">
      <label>Álbum ID:</label>
      <strong id="album-id"></strong>
    </div>

    <!-- Renombrar -->
    <div class="section">
      <label for="album-name">Nombre del álbum</label>
      <input type="text" id="album-name" placeholder="Mi álbum de fotos"/>
      <button id="save-name">Guardar nombre</button>
    </div>

    <!-- Borrar álbum -->
    <div class="section">
      <button id="delete-album" style="background:#e74c3c;">Eliminar álbum</button>
    </div>

    <!-- Subir imágenes -->
    <div class="section">
      <label for="file-input">Subir imágenes</label>
      <input type="file" id="file-input" multiple accept="image/*"/>
      <button id="upload-btn">Subir</button>
    </div>

    <!-- Lista de imágenes -->
    <div class="section">
      <label>Imágenes en este álbum</label>
      <ul id="images-list"></ul>
    </div>
  </section>

  <!-- Supabase y scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabaseClient.js"></script>
  <script src="script.js"></script>
  <script>
    (async () => {
      // Param: code=ID_DEL_ALBUM
      const params = new URLSearchParams(window.location.search);
      const albumId = params.get('code');
      if (!albumId) return alert('Falta el ID del álbum.');

      document.getElementById('album-id').innerText = albumId;

      // 1) Sesión
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) {
        const redir = encodeURIComponent(`/album.html?code=${albumId}`);
        return window.location.href = `login.html?redirect=${redir}`;
      }
      const user = session.user;
      document.getElementById('sidebar-user').innerText = user.email;

      document.getElementById('logout').onclick = async e => {
        e.preventDefault();
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      };

      // 2) Cargar datos del álbum
      const { data: album, error: albErr } = await supabase
        .from('galleries')
        .select('name, user_id')
        .eq('id', albumId)
        .maybeSingle();
      if (albErr || !album || album.user_id !== user.id) {
        return alert('Álbum no válido o sin permiso.');
      }
      document.getElementById('album-name').value = album.name;

      // 3) Guardar nombre
      document.getElementById('save-name').onclick = async () => {
        const newName = document.getElementById('album-name').value.trim();
        if (!newName) return alert('Escribe un nombre.');
        const { error } = await supabase
          .from('galleries')
          .update({ name: newName })
          .eq('id', albumId);
        if (error) return alert('Error al renombrar.');
        alert('Nombre actualizado.');
      };

      // 4) Eliminar álbum (y todas sus imágenes)
      document.getElementById('delete-album').onclick = async () => {
        if (!confirm('Eliminar este álbum y todas sus imágenes?')) return;
        // Borrado en tabla images
        await supabase.from('images').delete().eq('gallery_id', albumId);
        // Borrado en tabla galleries
        const { error } = await supabase.from('galleries').delete().eq('id', albumId);
        if (error) return alert('Error al eliminar álbum.');
        // Volver a administrar (no know tv code aquí) o a galerías
        window.location.href = 'galeria.html';
      };

      // 5) Función para recargar lista de imágenes
      async function loadImages() {
        const { data: imgs } = await supabase
          .from('images')
          .select('id, url')
          .eq('gallery_id', albumId)
          .order('created_at', { ascending: false });

        const list = document.getElementById('images-list');
        list.innerHTML = '';
        for (const img of imgs) {
          // ruta pública
          const { data: { publicUrl }} = supabase
            .storage
            .from('images')
            .getPublicUrl(img.url);

          const li = document.createElement('li');
          const image = document.createElement('img');
          image.src = publicUrl;
          li.appendChild(image);

          const btn = document.createElement('button');
          btn.textContent = '×';
          btn.className = 'delete-btn';
          btn.onclick = async () => {
            if (!confirm('Borrar esta imagen?')) return;
            // borrar registro
            await supabase.from('images').delete().eq('id', img.id);
            // borrar del storage
            await supabase.storage.from('images').remove([img.url]);
            loadImages();
          };
          li.appendChild(btn);
          list.appendChild(li);
        }
      }

      // 6) Subir imágenes seleccionadas
      document.getElementById('upload-btn').onclick = async () => {
        const files = document.getElementById('file-input').files;
        if (!files.length) return alert('Selecciona al menos una imagen.');
        for (let file of files) {
          const path = `${albumId}/${Date.now()}_${file.name}`;
          // upload
          const { data: uploadData, error: upErr } = await supabase
  .storage
  .from('images')
  .upload(path, file, { upsert: false });
if (upErr) {
  console.error('Upload error:', upErr);
  alert(`Error subiendo ${file.name}: ${upErr.message}`);
  continue;
}
          // insert record con url = path
          await supabase.from('images').insert({
            gallery_id: albumId,
            url: path
          });
        }
        document.getElementById('file-input').value = null;
        loadImages();
      };

      // primera carga
      loadImages();
    })();
  </script>
</body>
</html>
