<!DOCTYPE html>
<html lang="es">
<head>
  <base href="/" />
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Álbum - Zolian App</title>

  <!-- Estilos y Boxicons -->
  <link rel="stylesheet" href="style.css"/>
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>

  <style>
    .home { padding: 20px; transition: left 0.3s, width 0.3s; }
    .home .text { margin-bottom: 16px; }

    .section { margin-bottom: 24px; }
    .section label { display: block; margin-bottom: 8px; color: var(--text-color); }
    .section input[type="text"],
    .section input[type="file"],
    .section button {
      display: block;
      width: 100%;
      box-sizing: border-box;
    }
    .section input[type="text"] {
      padding: 8px; border:1px solid #ccc; border-radius:4px;
      margin-bottom: 8px;
      background: var(--body-color); color: var(--text-color);
    }
    .section input[type="file"] {
      margin-bottom: 8px;
    }
    .section button {
      padding: 10px; margin-bottom: 8px;
      background: var(--primary-color); color: #fff;
      border: none; border-radius:4px; cursor:pointer;
    }

    #images-list {
      list-style: none;
      padding: 0;
    }
    #images-list li {
      position: relative;
      margin-bottom: 12px;
    }
    #images-list img {
      max-width: 100%;
      border-radius: 4px;
      display: block;
    }
    #images-list .delete-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: rgba(0,0,0,0.5);
      color: #fff; border:none; border-radius:50%;
      width:24px; height:24px; cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- Contenedor donde se inyecta el sidebar -->
  <div id="sidebar-container"></div>

  <!-- Contenido principal -->
  <section class="home">
    <div class="text">Administrar Álbum</div>
<!-- Botón para forzar inicio en TV -->
  <div class="section">
    <button id="start-tv" style="background:#2ecc71;">Iniciar TV</button>
  </div>
    <!-- Mostrar ID del álbum -->
    <div class="section">
      <label>Álbum ID:</label>
      <strong id="album-id"></strong>
    </div>

    <!-- Renombrar -->
    <div class="section">
      <label for="album-name">Nombre del álbum</label>
      <input type="text" id="album-name" placeholder="Mi álbum de fotos"/>
      <button id="save-name">Guardar nombre</button>
    </div>

    <!-- Borrar álbum -->
    <div class="section">
      <button id="delete-album" style="background:#e74c3c;">Eliminar álbum</button>
    </div>

    <!-- Subir imágenes -->
    <div class="section">
      <label for="file-input">Subir imágenes</label>
      <input type="file" id="file-input" multiple accept="image/*"/>
      <button id="upload-btn">Subir</button>
    </div>

    <!-- Lista de imágenes -->
    <div class="section">
      <label>Imágenes en este álbum</label>
      <ul id="images-list"></ul>
    </div>
  </section>

  <!-- Supabase y scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="supabaseClient.js"></script>
  <script src="script.js"></script>
  <script>
    // Esta función arranca solo cuando el sidebar ya está listo
    async function initAlbum() {
      // Obtener ID de álbum de la URL
      const params = new URLSearchParams(window.location.search);
      const albumId = params.get('code');
      if (!albumId) return alert('Falta el ID del álbum.');
      document.getElementById('album-id').innerText = albumId;

      // Comprobar sesión
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const redir = encodeURIComponent(`/album.html?code=${albumId}`);
        return window.location.href = `login.html?redirect=${redir}`;
      }
      const user = session.user;

      // Inyectar email en sidebar
      const sidebarUser = document.getElementById('sidebar-user');
      if (sidebarUser) sidebarUser.innerText = user.email;

      // Logout seguro
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.onclick = async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = 'login.html';
        };
      }

      // Cargar álbum
      const { data: album, error: albErr } = await supabase
        .from('galleries')
        .select('name,user_id')
        .eq('id', albumId)
        .maybeSingle();
      if (albErr || !album || album.user_id !== user.id) {
        return alert('Álbum no válido o sin permiso.');
      }
      document.getElementById('album-name').value = album.name;

      // Guardar nombre
      const saveBtn = document.getElementById('save-name');
      if (saveBtn) {
        saveBtn.onclick = async () => {
          const newName = document.getElementById('album-name').value.trim();
          if (!newName) return alert('Escribe un nombre.');
          const { error } = await supabase
            .from('galleries')
            .update({ name: newName })
            .eq('id', albumId);
          if (error) return alert('Error al renombrar.');
          alert('Nombre actualizado.');
        };
      }

      // Eliminar álbum
      const delBtn = document.getElementById('delete-album');
      if (delBtn) {
        delBtn.onclick = async () => {
          if (!confirm('Eliminar este álbum y todas sus imágenes?')) return;
          await supabase.from('images').delete().eq('gallery_id', albumId);
          const { error } = await supabase.from('galleries').delete().eq('id', albumId);
          if (error) return alert('Error al eliminar álbum.');
          window.location.href = 'galeria.html';
        };
      }

      // Función para cargar imágenes
      async function loadImages() {
        const { data: imgs } = await supabase
          .from('images')
          .select('id,url')
          .eq('gallery_id', albumId)
          .order('created_at', { ascending: false });
        await supabase
    .from('tv')
     .update({ play: true })
     .eq('code', albumId);
  }
// Listener para el botón manual
 const btnStart = document.getElementById('start-tv');
 if (btnStart) {
   btnStart.onclick = async () => {
     await supabase
       .from('tv')
       .update({ play: true })
       .eq('code', albumId);
     alert('Se ha enviado la señal al TV');
   };
 }
        const list = document.getElementById('images-list');
        list.innerHTML = '';
        for (const img of imgs) {
          const { data: { publicUrl }} = supabase
            .storage
            .from('images')
            .getPublicUrl(img.url);

          const li = document.createElement('li');
          const image = document.createElement('img');
          image.src = publicUrl;
          li.appendChild(image);

          const btn = document.createElement('button');
          btn.textContent = '×';
          btn.className = 'delete-btn';
          btn.onclick = async () => {
            if (!confirm('Borrar esta imagen?')) return;
            await supabase.from('images').delete().eq('id', img.id);
            await supabase.storage.from('images').remove([img.url]);
            loadImages();
          };
          li.appendChild(btn);
          list.appendChild(li);
        }
      }

      // Subir imágenes
      const uploadBtn = document.getElementById('upload-btn');
      if (uploadBtn) {
        uploadBtn.onclick = async () => {
          const files = document.getElementById('file-input').files;
          if (!files.length) return alert('Selecciona al menos una imagen.');
          for (let file of files) {
            const path = `${albumId}/${Date.now()}_${file.name}`;
            const { error: upErr } = await supabase
              .storage
              .from('images')
              .upload(path, file, { upsert: false });
            if (upErr) {
              console.error('Upload error:', upErr);
              alert(`Error subiendo ${file.name}: ${upErr.message}`);
              continue;
            }
            await supabase.from('images').insert({ gallery_id: albumId, url: path });
          }
          document.getElementById('file-input').value = null;
          loadImages();
        };
      }

      // Primera carga de imágenes
      loadImages();
    }

    // Ejecutar cuando sidebar esté listo
    window.addEventListener('sidebarReady', initAlbum);
  </script>
</body>
</html>
