<!DOCTYPE html>
<html lang="es">
<head>
  <base href="/" />
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Álbum - Zolian App</title>

  <link rel="stylesheet" href="/style.css"/>
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/boxicons@2.1.1/dist/boxicons.js"></script>

  <style>
    .home { padding:20px; }
    .section { margin-bottom:24px; }
    .section input, .section button { width:100%; box-sizing:border-box; margin-top:8px; }
    #images-list { list-style:none; padding:0; }
    #images-list img { max-width:100%; border-radius:4px; display:block; }
    .delete-btn {
      position:absolute; top:8px; right:8px;
      background:rgba(0,0,0,0.5); color:#fff;
      border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;
    }
    #images-list li { position:relative; margin-bottom:12px; }
  </style>
</head>
<body>
  <div id="sidebar-container"></div>

  <section class="home">
    <div class="text">Administrar Álbum</div>

    <div class="section">
      <button id="start-tv" style="background:#2ecc71;">
        <box-icon name='tv'></box-icon> Iniciar TV
      </button>
    </div>

    <div class="section">
      <label>TV Code:</label><strong id="tv-code"></strong>
    </div>
    <div class="section">
      <label>Álbum ID:</label><strong id="album-id"></strong>
    </div>

    <div class="section">
      <label for="album-name">Nombre del álbum</label>
      <input type="text" id="album-name" placeholder="Mi álbum de fotos"/>
      <button id="save-name">Guardar nombre</button>
    </div>

    <div class="section">
      <button id="delete-album" style="background:#e74c3c;">
        <box-icon name='trash'></box-icon> Eliminar álbum
      </button>
    </div>

    <div class="section">
      <label for="file-input">Subir imágenes</label>
      <input type="file" id="file-input" multiple accept="image/*"/>
      <button id="upload-btn">
        <box-icon name='upload'></box-icon> Subir
      </button>
    </div>

    <div class="section">
      <label>Imágenes en este álbum</label>
      <ul id="images-list"></ul>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <script src="/script.js"></script>
  <script>
    async function initAlbum() {
      const params  = new URLSearchParams(window.location.search);
      const tvCode  = params.get('code');
      const gallery = params.get('gallery');

      if (!tvCode || !gallery) {
        alert('Faltan parámetros en la URL (code y gallery).');
        return;
      }
      document.getElementById('tv-code').innerText    = tvCode;
      document.getElementById('album-id').innerText   = gallery;

      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) {
        const redir = encodeURIComponent(`/album.html?code=${tvCode}&gallery=${gallery}`);
        return window.location.href = `login.html?redirect=${redir}`;
      }

      // inyectar email y logout
      const su = document.getElementById('sidebar-user');
      if (su) su.innerText = session.user.email;
      const lb = document.getElementById('logout');
      if (lb) lb.onclick = async (e) => {
        e.preventDefault();
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      };

      // cargar nombre del álbum
      const { data: alb } = await supabase
        .from('galleries').select('name,user_id')
        .eq('id', gallery).maybeSingle();
      if (!alb || alb.user_id !== session.user.id) {
        alert('Álbum no válido.');
        return;
      }
      document.getElementById('album-name').value = alb.name;

      // guardar nombre
      document.getElementById('save-name').onclick = async () => {
        const nv = document.getElementById('album-name').value.trim();
        if (!nv) return alert('Escribe un nombre.');
        const { error } = await supabase
          .from('galleries').update({ name: nv }).eq('id', gallery);
        if (error) return alert('Error al renombrar.');
        alert('Nombre actualizado.');
      };

      // eliminar álbum
      document.getElementById('delete-album').onclick = async () => {
        if (!confirm('Eliminar este álbum y sus imágenes?')) return;
        await supabase.from('images').delete().eq('gallery_id', gallery);
        await supabase.from('galleries').delete().eq('id', gallery);
        window.location.href = 'galeria';
      };

      // subir imágenes
      document.getElementById('upload-btn').onclick = async () => {
        const files = document.getElementById('file-input').files;
        if (!files.length) return alert('Selecciona al menos una imagen.');
        for (let f of files) {
          const path = `${gallery}/${Date.now()}_${f.name}`;
          const { error: upErr } = await supabase
            .storage.from('images').upload(path,f);
          if (upErr) {
            console.error(upErr);
            alert(`Error subiendo ${f.name}: ${upErr.message}`);
            continue;
          }
          await supabase.from('images').insert({ gallery_id:gallery, url:path });
        }
        loadImages();
      };

      // listar imágenes
      async function loadImages() {
        const { data:imgs } = await supabase
          .from('images').select('id,url')
          .eq('gallery_id',gallery).order('created_at',{ascending:false});
        const lst = document.getElementById('images-list');
        lst.innerHTML = '';
        for (let {id,url} of imgs) {
          let pu;
          // public
          pu = supabase.storage.from('images').getPublicUrl(url).data.publicUrl;
          const li = document.createElement('li'),
                im = document.createElement('img'),
                bt = document.createElement('button');
          im.src = pu; li.appendChild(im);
          bt.textContent = '×'; bt.className='delete-btn';
          bt.onclick = async () => {
            if (!confirm('Borrar imagen?')) return;
            await supabase.from('images').delete().eq('id',id);
            await supabase.storage.from('images').remove([url]);
            loadImages();
          };
          li.appendChild(bt);
          lst.appendChild(li);
        }
      }

      // botón iniciar TV -> set play=true
      document.getElementById('start-tv').onclick = async () => {
   // 1) Primero asignamos el álbum a esta TV
   const { error: e1 } = await supabase
     .from('tv')
     .update({ gallery_id: albumId })
     .eq('code', tvCode);
   if (e1) return alert('Error al vincular álbum: ' + e1.message);

   // 2) Ahora sí disparamos el play
   const { error: e2 } = await supabase
     .from('tv')
     .update({ play: true })
     .eq('code', tvCode);
   if (e2) return alert('Error al iniciar TV: ' + e2.message);

   alert('Se ha enviado la señal al TV.');
      };

      await loadImages();
    }

    window.addEventListener('sidebarReady', initAlbum);
  </script>
</body>
</html>
