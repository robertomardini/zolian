<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>Administrar √Ålbum ‚Äì Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/style.css"/>
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/browser-image-compression/dist/browser-image-compression.js"></script>
</head>
<body>
  <!-- Sidebar inyectado -->
  <div id="sidebar-container"></div>
  <div class="overlay"></div>

  <section class="home">
    <!-- T√≠tulo -->
    <div class="text">Administrar √Ålbum</div>

    <!-- Bloque 1: Ajustes -->
    <div class="album-block">
      <div class="field-group">
        <label for="album-name">Nombre del √°lbum</label>
        <input type="text" id="album-name" placeholder="Mi √°lbum de fotos"/>
      </div>
      <div class="field-group">
        <label for="duration">Duraci√≥n por imagen (s)</label>
        <input type="number" id="duration" min="1" value="5"/>
      </div>
      <div class="field-group">
        <label for="slideshow-type">Tipo de slideshow</label>
        <select id="slideshow-type">
          <option value="fade">Fade</option>
          <option value="slide">Slide Horizontal</option>
          <option value="vertical">Slide Vertical</option>
          <option value="zoom">Zoom</option>
          <option value="kenburns">Ken Burns</option>
        </select>
      </div>
      <div class="field-group actions">
        <button id="save-settings">
          <box-icon name='save' type='solid' size='20px'></box-icon>
          Guardar cambios
        </button>
      </div>
    </div>

    <!-- Bloque 2: Im√°genes y env√≠o -->
    <div class="album-block">
      <div class="field-group">
        <label for="file-input">Cargar im√°genes</label>
        <input type="file" id="file-input" multiple accept="image/*"/>
        <button id="upload-btn">
          <box-icon name='upload' type='solid' size='20px'></box-icon>
          Subir
        </button>
        <span id="upload-status"></span>
      </div>

      <ul id="images-list"></ul>

      <div class="field-group send-group">
        <label for="tv-select">Enviar a pantalla</label>
        <select id="tv-select">
          <option value="">‚Äî Selecciona pantalla ‚Äî</option>
        </select>
        <button id="send-btn">
          <box-icon name='play' type='solid' size='20px'></box-icon>
          Enviar
        </button>
      </div>
    </div>

    <!-- Texto Eliminar √°lbum -->
    <p id="delete-album" class="delete-link">üóë Eliminar √°lbum</p>
  </section>

  <script src="/script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>
  <script>
    async function initAlbum() {
      const params    = new URLSearchParams(location.search);
      const galleryId = params.get('gallery');
      if (!galleryId) {
        alert('Falta par√°metro gallery.');
        return window.location.href = 'galeria.html';
      }

      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) {
        const r = encodeURIComponent(location.pathname + location.search);
        return window.location.href = `login.html?redirect=${r}`;
      }

      // Inyectar email en sidebar (si existe)
      const sidebarUser = document.getElementById('sidebar-user');
      if (sidebarUser) sidebarUser.innerText = session.user.email;

      // Cargar datos del √°lbum
      const { data: alb, error: albErr } = await supabase
        .from('galleries')
        .select('name,duration,slideshow_type')
        .eq('id', galleryId)
        .maybeSingle();
      if (albErr || !alb) {
        alert('No se pudo cargar el √°lbum.');
        return;
      }
      document.getElementById('album-name').value     = alb.name;
      document.getElementById('duration').value       = alb.duration;
      document.getElementById('slideshow-type').value = alb.slideshow_type;

      // Guardar ajustes
      document.getElementById('save-settings').onclick = async () => {
        const name = document.getElementById('album-name').value.trim();
        const dur  = parseInt(document.getElementById('duration').value) || 5;
        const type = document.getElementById('slideshow-type').value;
        if (!name) return alert('Escribe un nombre.');
        const { error } = await supabase
          .from('galleries')
          .update({ name, duration: dur, slideshow_type: type })
          .eq('id', galleryId);
        if (error) alert('Error guardando: ' + error.message);
        else       alert('Cambios guardados correctamente.');
      };

      // Subir im√°genes
      document.getElementById('upload-btn').onclick = async () => {
        const inp  = document.getElementById('file-input');
        const stat = document.getElementById('upload-status');
        if (!inp.files.length) return alert('Selecciona alguna imagen');
        inp.disabled   = true;
        stat.innerText = 'Procesando...';
        for (let file of inp.files) {
          let compressed;
          try {
            compressed = await imageCompression(file, {
              maxWidthOrHeight: 3840,
              maxSizeMB:        1,
              fileType:         'image/webp',
              useWebWorker:     true
            });
          } catch {
            compressed = file;
          }
          const newName = file.name.replace(/\.\w+$/, '.webp');
          const path    = `${galleryId}/${Date.now()}_${newName}`;
          const { error: upErr } = await supabase
            .storage.from('images').upload(path, compressed, { contentType: 'image/webp' });
          if (upErr) {
            console.error(upErr);
            alert(`Error subiendo ${newName}: ${upErr.message}`);
            continue;
          }
          await supabase.from('images').insert({ gallery_id: galleryId, url: path });
        }
        inp.value      = '';
        inp.disabled   = false;
        stat.innerText = '';
        loadImages();
      };

      // Cargar miniaturas
      async function loadImages() {
        const { data: imgs } = await supabase
          .from('images')
          .select('id,url')
          .eq('gallery_id', galleryId)
          .order('created_at',{ ascending:false });
        const ul = document.getElementById('images-list');
        ul.innerHTML = '';
        for (let img of imgs) {
          const publicUrl = supabase.storage.from('images').getPublicUrl(img.url).data.publicUrl;
          const li = document.createElement('li');
          li.innerHTML = `
            <img src="${publicUrl}">
            <button class="delete-btn">√ó</button>
          `;
          li.querySelector('button').onclick = async () => {
            if (!confirm('Borrar imagen?')) return;
            await supabase.from('images').delete().eq('id', img.id);
            await supabase.storage.from('images').remove([img.url]);
            loadImages();
          };
          ul.appendChild(li);
        }
      }
      loadImages();

      // Listar pantallas
      const { data: tvs } = await supabase
        .from('tv')
        .select('code,nombre')
        .eq('user_id', session.user.id);
      const sel = document.getElementById('tv-select');
      sel.innerHTML = '<option value="">‚Äî Selecciona pantalla ‚Äî</option>';
      tvs.forEach(t => {
        const o = document.createElement('option');
        o.value       = t.code;
        o.textContent = t.nombre || t.code;
        sel.appendChild(o);
      });

      // Enviar a TV
      document.getElementById('send-btn').onclick = async () => {
        const code = sel.value;
        if (!code) return alert('Selecciona una pantalla');
        const dur  = parseInt(document.getElementById('duration').value) || 5;
        const type = document.getElementById('slideshow-type').value;
        const { error } = await supabase
          .from('tv')
          .update({
            gallery_id:     galleryId,
            duration:       dur,
            slideshow_type: type,
            play:           true,
            video_url:      null
          })
          .eq('code', code);
        if (error) alert('Error al enviar: ' + error.message);
        else       alert('¬°Listo! La TV mostrar√° este √°lbum.');
      };

      // Eliminar √°lbum
      document.getElementById('delete-album').onclick = async () => {
        if (!confirm('Eliminar √°lbum y todas sus im√°genes?')) return;
        const { data: imgs } = await supabase.from('images').select('url').eq('gallery_id', galleryId);
        const paths = imgs.map(i => i.url);
        if (paths.length) {
          await supabase.storage.from('images').remove(paths);
        }
        await supabase.from('images').delete().eq('gallery_id', galleryId);
        await supabase.from('galleries').delete().eq('id', galleryId);
        window.location.href = 'galeria.html';
      };
    }

    document.addEventListener('DOMContentLoaded', initAlbum);
    window.addEventListener('sidebarReady', initAlbum);
  </script>
</body>
</html>
