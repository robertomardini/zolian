<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <title>√Ålbum ‚Äì Zolian App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Estilos globales -->
  <link rel="stylesheet" href="/style.css"/>
  <!-- Boxicons para iconos -->
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/boxicons@2.1.1/dist/boxicons.js"></script>
  <style>
    .home { padding:20px; transition:left .3s, width .3s; }
    .home .text { font-size:2rem; margin-bottom:24px; color:var(--text-color); text-align:center; }
    .section { margin-bottom:16px; }
    .input-group { display:flex; gap:8px; }
    .input-group input, .input-group select {
      flex:1; padding:8px; border:none; border-radius:6px;
      background:var(--sidebar-color); color:var(--text-color);
    }
    .input-group button {
      padding:8px 16px; background:var(--primary-color);
      color:#fff; border:none; border-radius:6px; cursor:pointer;
    }
    #images-list {
      display:grid; grid-template-columns:repeat(3,1fr);
      gap:16px; list-style:none; padding:0;
    }
    #images-list li {
      position:relative; border-radius:6px;
      overflow:hidden; background:#fff;
    }
    #images-list img {
      width:100%; height:100%; object-fit:cover;
    }
    .delete-btn {
      position:absolute; top:8px; right:8px;
      background:rgba(0,0,0,.6); color:#fff;
      border:none; border-radius:50%; width:24px;
      height:24px; cursor:pointer;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container"></div>

  <section class="home">
    <div class="text">Administrar √Ålbum</div>

    <!-- Usuario -->
    <p>Usuario: <strong id="user-email"></strong></p>

    <!-- Nombre del √°lbum -->
    <div class="section">
      <label for="album-name">Nombre del √°lbum</label>
      <div class="input-group">
        <input type="text" id="album-name" placeholder="Mi √°lbum de fotos"/>
      </div>
    </div>

    <!-- Duraci√≥n -->
    <div class="section">
      <label for="duration">Duraci√≥n por imagen (s)</label>
      <input type="number" id="duration" min="1" value="5"/>
    </div>

    <!-- Tipo de slideshow -->
    <div class="section">
      <label for="slideshow-type">Tipo de slideshow</label>
      <select id="slideshow-type">
        <option value="fade">Fade</option>
        <option value="slide">Slide Horizontal</option>
        <option value="vertical">Slide Vertical</option>
        <option value="zoom">Zoom</option>
        <option value="kenburns">Ken Burns</option>
      </select>
    </div>

    <!-- Bot√≥n Guardar Cambios -->
    <div class="section">
      <button id="save-settings">üíæ Guardar cambios</button>
    </div>

    <!-- Subir im√°genes -->
    <div class="section">
      <label for="file-input">Cargar im√°genes</label>
      <div class="input-group">
        <input type="file" id="file-input" multiple accept="image/*"/>
        <button id="upload-btn">‚¨ÜÔ∏è Subir</button>
        <span id="upload-status"></span>
      </div>
    </div>

    <!-- Miniaturas -->
    <div class="section">
      <ul id="images-list"></ul>
    </div>

    <!-- Enviar a pantalla -->
    <div class="section">
      <label for="tv-select">Enviar a pantalla</label>
      <div class="input-group">
        <select id="tv-select">
          <option value="">‚Äî Selecciona pantalla ‚Äî</option>
        </select>
        <button id="send-btn">‚ñ∂Ô∏è Enviar</button>
      </div>
    </div>

    <!-- Eliminar √°lbum -->
    <div class="section">
      <button id="delete-album" style="background:#e74c3c;">
        üóë Eliminar √°lbum
      </button>
    </div>
  </section>

  <!-- Inyecta sidebar -->
  <script src="/script.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="/supabaseClient.js"></script>

  <script>
    async function initAlbum() {
      const params    = new URLSearchParams(window.location.search);
      const galleryId = params.get('gallery');
      if (!galleryId) {
        alert('Falta par√°metro gallery.');
        window.location.href = 'galeria.html';
        return;
      }

      // Sesi√≥n
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) {
        const r = encodeURIComponent(location.pathname + location.search);
        window.location.href = `login.html?redirect=${r}`;
        return;
      }

      // Mostrar email
      document.getElementById('user-email').innerText = session.user.email;
      const sidebarUser = document.getElementById('sidebar-user');
      if (sidebarUser) sidebarUser.innerText = session.user.email;

      // Leer datos del √°lbum
      const { data: alb, error: albErr } = await supabase
        .from('galleries')
        .select('name,duration,slideshow_type')
        .eq('id', galleryId)
        .maybeSingle();
      if (albErr || !alb) {
        alert('No se pudo cargar el √°lbum.');
        return;
      }
      document.getElementById('album-name').value     = alb.name;
      document.getElementById('duration').value       = alb.duration;
      document.getElementById('slideshow-type').value = alb.slideshow_type;

      // Guardar cambios
      document.getElementById('save-settings').onclick = async () => {
        const name = document.getElementById('album-name').value.trim();
        const dur  = parseInt(document.getElementById('duration').value) || 5;
        const type = document.getElementById('slideshow-type').value;
        if (!name) {
          alert('Escribe un nombre.');
          return;
        }
        const { error } = await supabase
          .from('galleries')
          .update({ name, duration: dur, slideshow_type: type })
          .eq('id', galleryId);
        if (error) {
          alert('Error guardando: ' + error.message);
        } else {
          alert('Cambios guardados correctamente.');
        }
      };

      // Subir im√°genes
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = async () => {
        const inp = document.getElementById('file-input');
        const stat = document.getElementById('upload-status');
        if (!inp.files.length) {
          alert('Selecciona alguna imagen');
          return;
        }
        uploadBtn.disabled = true;
        stat.innerText     = 'Subiendo...';

        for (let f of inp.files) {
          const path = `${galleryId}/${Date.now()}_${f.name}`;
          const { error: upErr } = await supabase.storage.from('images').upload(path, f);
          if (upErr) {
            console.error(upErr);
            alert(`Error subiendo ${f.name}: ${upErr.message}`);
            continue;
          }
          await supabase.from('images').insert({ gallery_id: galleryId, url: path });
        }

        inp.value = '';
        stat.innerText     = '';
        uploadBtn.disabled = false;
        await loadImages();
      };

      // Cargar miniaturas
      async function loadImages() {
        const { data: imgs } = await supabase
          .from('images')
          .select('id,url')
          .eq('gallery_id', galleryId)
          .order('created_at',{ ascending:false });
        const ul = document.getElementById('images-list');
        ul.innerHTML = '';
        for (let img of imgs) {
          const publicUrl = supabase.storage.from('images').getPublicUrl(img.url).data.publicUrl;
          const li = document.createElement('li');
          li.innerHTML = `
            <img src="${publicUrl}">
            <button class="delete-btn">√ó</button>
          `;
          li.querySelector('button').onclick = async () => {
            if (!confirm('Borrar imagen?')) return;
            await supabase.from('images').delete().eq('id', img.id);
            await supabase.storage.from('images').remove([img.url]);
            await loadImages();
          };
          ul.appendChild(li);
        }
      }
      await loadImages();

      // Listar pantallas
      const { data: tvs } = await supabase
        .from('tv')
        .select('code,nombre')
        .eq('user_id', session.user.id);
      const sel = document.getElementById('tv-select');
      tvs.forEach(t => {
        const o = document.createElement('option');
        o.value       = t.code;
        o.textContent = t.nombre || t.code;
        sel.appendChild(o);
      });

      // Enviar a TV
      document.getElementById('send-btn').onclick = async () => {
        const code = sel.value;
        if (!code) {
          alert('Selecciona una pantalla');
          return;
        }
        const dur  = parseInt(document.getElementById('duration').value) || 5;
        const type = document.getElementById('slideshow-type').value;
        const { error } = await supabase
          .from('tv')
          .update({
            gallery_id:     galleryId,
            duration:       dur,
            slideshow_type: type,
            play:           true,
            video_url:      null
          })
          .eq('code', code);
        if (error) {
          alert('Error al enviar: ' + error.message);
        } else {
          alert('¬°Listo! La TV mostrar√° este √°lbum.');
        }
      };

      // Eliminar √°lbum
      document.getElementById('delete-album').onclick = async () => {
        if (!confirm('Eliminar √°lbum y todas sus im√°genes?')) return;
        await supabase.from('images').delete().eq('gallery_id', galleryId);
        await supabase.from('galleries').delete().eq('id', galleryId);
        window.location.href = 'galeria.html';
      };
    }

    // Inicializamos cuando el sidebar est√© listo
    window.addEventListener('sidebarReady', initAlbum);
  </script>
</body>
</html>
